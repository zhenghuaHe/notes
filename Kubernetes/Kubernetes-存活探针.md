# Kubernetes判断业务存活

* 探针是由 kubelet 对容器执行的定期诊断。要执行诊断，kubelet 调用由容器实现的 Handler。有三种类型的处理程序：

1. ExecAction：在容器内执行指定命令。如果命令退出时返回码为 0 则认为诊断成功。
2. TCPSocketAction：对指定端口上的容器的 IP 地址进行 TCP 检查。如果端口打开，则诊断被认为是成功的。
3. HTTPGetAction：对指定的端口和路径上的容器的 IP 地址执行 HTTP Get 请求。如果响应的状态码大于等于200 且小于 400，则诊断被认为是成功的。

* 每次探测都将获得以下三种结果之一：
1. 成功：容器通过了诊断。
2. 失败：容器未通过诊断。
3. 未知：诊断失败，因此不会采取任何行动

* 常见的两种探针
    > livenessProbe：指示容器是否正在运行。如果存活探测失败，则kubelet会杀死容器，并且容器将受到其重启策略的影响。如果容器不提供存活探针，则默认状态为 Success。

    > readinessProbe：就绪探测是用于容器是否准备好服务请求。如果就绪探测失败，端点控制器将从与Pod匹配的所有Service的端点中删除该Pod的IP地址，然后重建。

* 探针有许多字段，您可以使用它们来更精确地控制活动和准备情况检查的行为：
```
initialDelaySeconds：启动活动或准备就绪探测之前容器启动后的秒数。
periodSeconds：执行探测的频率（以秒为单位）。默认为10秒。最小值为1。
timeoutSeconds：探测超时的秒数。默认为1秒。最小值为1。
successThreshold：失败后探测成功的最小连续成功次数。默认为1.活跃度必须为1。最小值为1。
failureThreshold：当Pod启动并且探测器失败时，Kubernetes会failureThreshold在放弃之前尝试一次。在活动探测的情况下放弃意味着重新启动Pod。如果准备好探测，Pod将被标记为未准备好。默认为3.最小值为1。
```
* Pod的重启策略
    > Pod的重启策略有3种，默认值为Always。

1. Always ： 容器失效时，kubelet自动重启该容器；
2. OnFailure ： 容器终止运行且退出码不为0时重启；
3. Never ： 不论状态为何，kubelet都不重启该容器。
    > 失败的容器由kubelet以五分钟为上限的指数退避延迟（10秒，20秒，40秒…）重新启动，并在成功执行十分钟后重置。
